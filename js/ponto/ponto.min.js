var Ponto={apiServer:"https://ponto.thiagopaes.dev.br",init:function(){if($("body > #container").empty(),$("<section/>").attr("id","Ponto").appendTo($("#container")),null!==localStorage.getItem("id")){$("#login-form").dialog("close"),$("#login-form").remove();var a=$("<header/>"),t=$("<ul/>");a.append($("<nav/>").append(t.append($("<li/>").append($("<a/>").html("+").attr("href","javascript:;").button().click(function(){Ponto.ponto()}))).append($("<li/>").append($("<a/>").html("Preferências").attr("href","javascript:;").button().click(function(){Ponto.preferencias()})))).append($("<span/>").html("Logado como: ").append($("<br/>")).append($("<b/>").html(localStorage.getItem("nome"))))).insertBefore($("#Ponto")),"null"==localStorage.getItem("owner")&&t.append($("<li/>").append($("<a/>").html("Usuários").attr("href","javascript:;").button().click(function(){Ponto.usuarios()}))),t.append($("<li/>").append($("<a/>").html("Sair").attr("href","javascript:;").button().click(function(){Ponto.logout()})));var o=localStorage.getItem("dias_trabalho").split(","),e=new Date;$.inArray(e.getDay().toString(),o)<0&&$("header nav ul li:eq(0)").hide(),Ponto.relatorio()}else Ponto.login()},_formLogin:function(){var a=$("<fieldset/>").append($("<label/>").attr("for","usuario").html("Usuário").append($("<input/>").attr("type","text").attr("name","usuario").attr("id","usuario").addClass("text ui-widget-content ui-corner-all"))).append($("<label/>").attr("for","senha").html("Senha").append($("<input/>").attr("type","password").attr("name","senha").attr("id","senha").addClass("text ui-widget-content ui-corner-all")));return $("<form/>").append(a)},_formCadastro:function(){var a=$("<fieldset/>").append($("<label/>").attr("for","Nome").html("Nome").append($("<input/>").attr("type","text").attr("name","nome").attr("id","nome").addClass("text ui-widget-content ui-corner-all required"))).append($("<label/>").attr("for","usuario").html("Login").append($("<input/>").attr("type","text").attr("name","usuario").attr("id","usuario").addClass("text ui-widget-content ui-corner-all required"))).append($("<label/>").attr("for","email").html("E-mail").append($("<input/>").attr("type","text").attr("name","email").attr("id","email").addClass("text ui-widget-content ui-corner-all required email"))).append($("<label/>").attr("for","senha").html("Senha").append($("<input/>").attr("type","password").attr("name","senha").attr("id","senha").addClass("text ui-widget-content ui-corner-all required"))).append($("<label/>").attr("for","senha_confirmacao").html("Repita").append($("<input/>").attr("type","password").attr("name","senha_confirmacao").attr("id","senha_confirmacao").addClass("text ui-widget-content ui-corner-all required"))).append($("<label/>").attr("for","horas_dia").html("Carga horária").append($("<input/>").attr("type","text").attr("name","horas_dia").attr("id","horas_dia").attr("maxlength","2").mask("9?9",{placeholder:" "}).addClass("text ui-widget-content ui-corner-all required"))).append($("<label/>").attr("for","horas_almoco").html("Intervalo").append($("<input/>").attr("type","text").attr("name","horas_almoco").attr("id","horas_almoco").attr("maxlength","2").mask("9?9",{placeholder:" "}).addClass("text ui-widget-content ui-corner-all required"))).append($("<fieldset/>").append($("<legend/>").html("Dias de Trabalho")).addClass("diasTrabalho").append($("<label/>").html("Dom").append($("<input/>").attr("type","checkbox").attr("name","dias_trabalho[]").attr("id","dias_trabalho_0").val("0"))).append($("<label/>").html("Seg").append($("<input/>").attr("type","checkbox").attr("name","dias_trabalho[]").attr("id","dias_trabalho_1").attr("checked",!0).val("1"))).append($("<label/>").html("Ter").append($("<input/>").attr("type","checkbox").attr("name","dias_trabalho[]").attr("id","dias_trabalho_2").attr("checked",!0).val("2"))).append($("<label/>").html("Qua").append($("<input/>").attr("type","checkbox").attr("name","dias_trabalho[]").attr("id","dias_trabalho_3").attr("checked",!0).val("3"))).append($("<label/>").html("Qui").append($("<input/>").attr("type","checkbox").attr("name","dias_trabalho[]").attr("id","dias_trabalho_4").attr("checked",!0).val("4"))).append($("<label/>").html("Sex").append($("<input/>").attr("type","checkbox").attr("name","dias_trabalho[]").attr("id","dias_trabalho_5").attr("checked",!0).val("5"))).append($("<label/>").html("Sáb").append($("<input/>").attr("type","checkbox").attr("name","dias_trabalho[]").attr("id","dias_trabalho_6").val("6")))).append($("<input/>").attr("type","hidden").attr("name","owner").attr("id","owner")).append($("<input/>").attr("type","hidden").attr("name","id").attr("id","id")),t=$("<form/>").attr("id","frmCadastro").append(a);return t},_formPonto:function(){var a=$("<fieldset/>").append($("<label/>").attr("for","observacao").html("Observação").append($("<textarea/>").attr("name","observacao").attr("id","observacao").addClass("text ui-widget-content ui-corner-all")));return $("<form/>").append(a)},_criaRelatorio:function(a){$(".widget-relatorio").remove(),$(".widget-grafico").remove(),$.ajax({type:"POST",url:Ponto.apiServer+"/relatorio.php",data:{usuario:localStorage.getItem("id"),data:a},success:function(t){if($("<div/>").attr("class","widget-relatorio").addClass("ui-widget ui-widget-content ui-helper-clearfix ui-corner-all").append($("<table/>").attr("id","tbRelatorio")).appendTo($("#Ponto")),$("<thead/>").append($("<tr/>").append($("<th/>").addClass("data").html("Data")).append($("<th/>").addClass("entrada").html("Entrada")).append($("<th/>").addClass("saida").html("Saída")).append($("<th/>").addClass("horas").html("Horas"))).addClass("ui-widget-header ui-helper-clearfix ui-corner-all").appendTo($("#tbRelatorio")),$("<tbody/>").appendTo($("#tbRelatorio")),0!==t.length){$.each(t,function(){var a=$("<tr/>").appendTo($("#tbRelatorio tbody"));a.append($("<td/>").addClass("data").html(this.data)).append($("<td/>").addClass("entrada").html(this.entrada)).append($("<td/>").addClass("saida").html(this.saida)).append($("<td/>").addClass("horas").html(this.horas));var t=this.obs;"string"==typeof t&&0!==t.length&&a.attr("title",t).addClass("comObs").tinyTips("title")});var o=parseInt(localStorage.getItem("horas_dia"),10),e=60*o,r=0,i=0,n=new Array,d=new Array,s=0;$("#tbRelatorio tbody tr").each(function(){var a=$(this),t=a.find("td:eq(0)").html(),o=a.find("td:eq(3)").html(),e=parseInt(t.substr(0,2),10),r=parseInt(o.substr(0,2),10),i=parseInt(o.substr(3,2),10);a.addClass("dia"+e),n[e]=n[e]?n[e]+(60*r+i):60*r+i,d[e]=n[e]/60});for(var l in n)n[l]<e?($("#tbRelatorio tbody tr.dia"+l).addClass("expedienteMenor"),i++):r++;var c=new jGCharts.Api;$("<img>").attr("src",c.make({data:[[r],[i]],type:"p3",size:"250x150",axis_labels:["Sim","Não"],title:"Assiduidade"})).addClass("widget-grafico").appendTo($("#Ponto"));var p=new jGCharts.Api;$("<img>").attr("src",p.make({data:[d],axis_labels:["Dias Trabalhados"],size:"250x150",type:"bvg",colors:["41599b"],bar_width:5,bar_spacing:1,title:"Horas/Dia"})).addClass("widget-grafico").appendTo($("#Ponto"));var m=localStorage.getItem("dias_trabalho").split(","),u=parseInt($(".ui-datepicker-calendar tr .ui-state-default:last").text()),h=0,g=a.split("-"),f=new Date(g[0],g[1],g[2]);for(f.setMonth(g[1]-1),f.setDate(1),l=1;u>=l;l++){var v=$.inArray(f.getDay().toString(),m);v>=0&&h++,f.setDate(f.getDate()+1)}for(l in d)s+=parseInt(d[l]);var b=new jGCharts.Api,_=o*h;$("<img>").attr("src",b.make({data:[[s,_]],type:"bhg",size:"250x120",axis_labels:[" "],legend:["Cumpridas ("+s+")","Mensal ("+_+")"],title:"Meta de horas do mês",colors:["DDD6F5","5131C9"],bar_width:30,bar_spacing:10,grid:!1})).addClass("widget-grafico").appendTo($("#Ponto"))}else $("<tr/>").append($("<td/>").attr("colspan","4").addClass("noResult").html("Sem dados")).appendTo($("#tbRelatorio tbody"))},dataType:"json"})},_removerUsuario:function(a){$.ajax({type:"POST",url:Ponto.apiServer+"/userdel.php",data:{usuario:localStorage.getItem("id"),usuarios:a.join("|")},success:function(a){1==a?Ponto.usuarios():($(this).dialog("close"),Ponto._showErro(a))},dataType:"json"})},_trocaUsuario:function(a){$("<div/>").attr("id","troca-form").html("Você deseja efetuar login como este usuário?").appendTo($("#Ponto")),$("#troca-form").dialog({title:"Logar como usuário",width:350,modal:!0,resizable:!1,buttons:{Continuar:function(){null==localStorage.getItem("inicial")&&localStorage.setItem("inicial",JSON.stringify({id:localStorage.getItem("id"),nome:localStorage.getItem("nome"),login:localStorage.getItem("login"),email:localStorage.getItem("email"),horas_dia:localStorage.getItem("horas_dia"),horas_almoco:localStorage.getItem("horas_almoco"),owner:localStorage.getItem("owner")})),Ponto._criaSessao(a),$(this).dialog("close"),$("#cadastro-form").remove(),$(".widget-usuarios").remove(),Ponto.init()},Fechar:function(){$(this).dialog("close"),$("#cadastro-form").remove()}},close:function(){$("#cadastro-form").remove()}})},_showErro:function(a){$("<div/>").html(a).attr("id","error").appendTo($("#Ponto")).dialog({title:"Erro",width:350,resizable:!1,modal:!0,buttons:{Fechar:function(){$(this).dialog("close"),$("#error").remove()}}})},_showMsg:function(a){$("<div/>").html(a).attr("id","message").appendTo($("#Ponto")).dialog({title:"",width:350,resizable:!1,modal:!0,buttons:{Fechar:function(){$(this).dialog("close"),$("#message").remove()}}})},_criaSessao:function(a){for(var t in a)localStorage.setItem(t,a[t])},_validaCadastro:function(){var a=new String;return 0===$("#nome").val().toString().length&&(a+="Nome inválido.<br>"),0===$("#usuario").val().toString().length&&(a+="Login inválido.<br>"),null===$("#email").val().toString().match(/^[A-Za-z0-9_\-\.]+@[A-Za-z0-9_\-\.]{2,}\.[A-Za-z0-9]{2,}(\.[A-Za-z0-9])?/)&&(a+="E-mail inválido.<br>"),$("input[type=password]").is(":visible")&&(0===$("#senha").val().toString().length&&(a+="Senha inválida.<br>"),$("#senha_confirmacao").val()!==$("#senha").val()&&(a+="Senha e confirmação são diferentes.<br>")),null===$("#horas_dia").val().toString().match(/^[0-9]+$/)&&(a+="Carga horária inválida.<br>"),a&&null===$("#horas_almoco").val().toString().match(/^[0-9]+$/)&&(a+="Intervalo inválido.<br>"),parseInt($("#horas_dia").val())<parseInt($("#horas_almoco").val())&&(a+="Você não pode ter um intervalo maior que sua carga horária.<br>"),a},_adicionarUsuario:function(){$("<div/>").attr("id","cadastro-form").appendTo($("#Ponto")),$(Ponto._formCadastro()).appendTo($("#cadastro-form")),$("#cadastro-form form #owner").val(localStorage.id),$("#cadastro-form").dialog({title:"Cadastro",width:250,modal:!0,resizable:!1,buttons:{Cadastrar:function(){var a=Ponto._validaCadastro();0===a.length?$.ajax({type:"POST",url:Ponto.apiServer+"/cadastro.php",data:$("#cadastro-form form").serialize(),success:function(a){a.id?($(this).dialog("close"),$("#cadastro-form").remove(),Ponto._showMsg("Usuário cadastrado.")):Ponto._showErro(a)},dataType:"json"}):Ponto._showErro(a)},Fechar:function(){$(this).dialog("close"),$("#cadastro-form").remove()}},close:function(){$("#cadastro-form").remove()}})},login:function(){$("<div/>").attr("id","login-form").appendTo($("#Ponto")),$("#login-form").append(Ponto._formLogin()),$("#login-form").dialog({title:"Efetuar login",width:250,modal:!0,resizable:!1,buttons:{Login:function(){var a=!0;a=a&&0!==$("#usuario").val().length,a=a&&0!==$("#senha").val().length,a===!0?$.ajax({type:"POST",url:Ponto.apiServer+"/login.php",data:$("#login-form form").serialize(),success:function(a){a.id?(Ponto._criaSessao(a),Ponto.init()):Ponto._showErro(a)},dataType:"json"}):Ponto._showErro("Preencha todos os campos")},Cadastro:function(){$("#login-form").dialog("close"),$("#login-form").remove(),Ponto.cadastro()}},close:function(){$("#login-form").remove(),Ponto.login()}})},logout:function(){var a="";if(null!==localStorage.getItem("inicial")){var t=JSON.parse(localStorage.getItem("inicial"));a="Sair do sistema ou apenas \nretornar ao usuário \noriginal?",$("<div/>").attr("id","troca-form").html(a).appendTo($("#Ponto")).dialog({title:"Logout",width:400,modal:!0,resizable:!1,buttons:{"Voltar ao estado inicial":function(){Ponto._criaSessao(t),localStorage.removeItem("inicial"),$(this).dialog("close"),$("#troca-form").remove(),Ponto.init()},Logout:function(){localStorage.clear(),$(this).dialog("close"),$("#troca-form").remove(),Ponto.init()},Cancelar:function(){$(this).dialog("close")}},close:function(){$("#troca-form").remove()}})}else a="Efetuar logout?",$("<div/>").attr("id","troca-form").html(a).appendTo($("#Ponto")).dialog({title:"Logout",width:350,modal:!0,resizable:!1,buttons:{Continuar:function(){localStorage.clear(),$(this).dialog("close"),Ponto.init()},Cancelar:function(){$(this).dialog("close")}},close:function(){$("#troca-form").remove()}})},ponto:function(){var a=localStorage.getItem("dias_trabalho").split(","),t=new Date;$.inArray(t.getDay().toString(),a)>=0?($("<div/>").attr("id","ponto-form").appendTo($("#Ponto")),$("#ponto-form").append(Ponto._formPonto()).dialog({title:"Registro de Ponto",width:350,modal:!0,resizable:!1,buttons:{Registrar:function(){$.ajax({type:"POST",url:Ponto.apiServer+"/ponto.php",data:{observacao:$("#ponto-form #observacao").val(),usuario:localStorage.getItem("id"),tipo:$("#ponto-form input[@name='tipo']:checked").val()},success:function(a){$(this).dialog("close"),$("#ponto-form").remove(),$("<div/>").html(a).attr("id","sucesso-ponto").appendTo($("#Ponto")).dialog({title:"Registro de Ponto",width:250,resizable:!1,modal:!0,buttons:{Fechar:function(){$("#sucesso-ponto").remove(),Ponto.relatorio()}}})},dataType:"json"})},Fechar:function(){$(this).dialog("close")}},close:function(){$("#ponto-form").remove()}}),$("#tbRelatorio")[0]&&""==$("#tbRelatorio tbody td.saida:first").text()&&$("#tipoSaida").attr("checked","true")):Ponto._showErro("Pelas suas configurações, não é possível bater o ponto hoje.")},preferencias:function(){$("<div/>").attr("id","cadastro-form").addClass("widget-preferencias").appendTo($("#Ponto")),$(Ponto._formCadastro()).appendTo($("#cadastro-form")),$("#cadastro-form form #nome").val(localStorage.getItem("nome")),$("#cadastro-form form #email").val(localStorage.getItem("email")),$("#cadastro-form form #usuario").val(localStorage.getItem("login")).attr("readonly","readonly"),$("#cadastro-form form #id").val(localStorage.getItem("id")),$("#cadastro-form form #owner").val(localStorage.getItem("owner")),$("#cadastro-form form #horas_dia").val(localStorage.getItem("horas_dia")),$("#cadastro-form form #horas_almoco").val(localStorage.getItem("horas_almoco")),$("#cadastro-form form input#usuario").hide(),$("#cadastro-form form input#usuario").parent().hide(),$("#cadastro-form form input[type=password]").hide(),$("#cadastro-form form input[type=password]").parent().hide();var a=localStorage.getItem("dias_trabalho").split(",");$("#cadastro-form form input[type=checkbox]").attr("checked",!1);for(var t in a)$("#cadastro-form form #dias_trabalho_"+a[t]).attr("checked",!0);$("#cadastro-form").dialog({title:"Preferências",width:320,modal:!0,resizable:!1,buttons:{Atualizar:function(){var a=Ponto._validaCadastro();0===a.length?$.ajax({type:"POST",url:Ponto.apiServer+"/cadastro.php",data:$("#cadastro-form form").serialize(),success:function(a){a.id?a.id?(Ponto._criaSessao(a),$(this).dialog("close"),$("#cadastro-form").remove(),Ponto.init()):Ponto._showErro(a):($(this).dialog("close"),Ponto._showErro(a))},dataType:"json"}):Ponto._showErro(a)},"Trocar Senha":function(){$("#cadastro-form form input[type=password]").toggle(),$("#cadastro-form form input[type=password]").parent().toggle()},Fechar:function(){$(this).dialog("close"),$("#cadastro-form").remove()}},close:function(){$("#cadastro-form").remove()}})},cadastro:function(){$("<div/>").attr("id","cadastro-form").appendTo($("#Ponto")),$(Ponto._formCadastro()).appendTo($("#cadastro-form")),$("#cadastro-form").dialog({title:"Cadastro",width:250,modal:!0,resizable:!1,buttons:{Cadastrar:function(){var a=Ponto._validaCadastro();0===a.length?$.ajax({type:"POST",url:Ponto.apiServer+"/cadastro.php",data:$("#cadastro-form form").serialize(),success:function(a){a.id?(Ponto._criaSessao(a),$(this).dialog("close"),$("#cadastro-form").remove(),$("#login-form").remove(),Ponto.init(),Ponto._showMsg("Bem vindo :)")):Ponto._showErro(a)},dataType:"json"}):Ponto._showErro(a)},Fechar:function(){$(this).dialog("close")}},close:function(){$("#cadastro-form").remove(),Ponto.login()}})},relatorio:function(){$("#Ponto").empty();var a=new Date,t=new Number(a.getMonth())+1,o=new Number(a.getDate()),e=1==t.length?"0"+t:t,r=1==o.length?"0"+o:o,i=a.getFullYear();$("<div/>").attr("class","widget-calendario").appendTo($("#Ponto")).datepicker({monthNames:["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],dayNamesMin:["Dom","Seg","Ter","Qua","Qui","Sex","Sab"],dayNames:["Domingo","Segunda","Terça","Quarta","Quinta","Sexta","Sábado"],dateFormat:"yy-mm-dd",firstDay:0,prevText:"Anterior",nextText:"Pr&oacute;ximo",defaultDate:i+"-"+e+"-"+r,showOtherMonths:!1,selectOtherMonths:!1,hideIfNoPrevNext:!0,maxDate:"+0d",onSelect:function(a){var t=a.split("-"),o=t[0]+"-"+t[1]+"-"+t[2];Ponto._criaRelatorio(o)},onChangeMonthYear:function(a,t){Ponto._criaRelatorio(a+"-"+t+"-31")}}),Ponto._criaRelatorio(i+"-"+e+"-"+r)},usuarios:function(){$("<div/>").addClass("widget-usuarios").appendTo($("#Ponto")),$.ajax({type:"POST",url:Ponto.apiServer+"/usuarios.php",data:{usuario:localStorage.getItem("id")},success:function(a){0!==a.length?($("<table/>").attr("id","tbUsuarios").appendTo($(".widget-usuarios")),$("<tbody/>").append($("<tr/>").append($("<td/>").addClass("id").html("#")).append($("<td/>").addClass("login").html("Login")).append($("<td/>").addClass("nome").html("Nome")).append($("<td/>").addClass("email").html("E-mail")).append($("<td/>").addClass("expediente").html("Expediente")).addClass("ui-widget-header")).appendTo($("#tbUsuarios")),$.each(a,function(a,t){var o=$("<tr/>").appendTo($("#tbUsuarios tbody"));o.append($("<td/>").addClass("id").append($("<input/>").attr("type","checkbox").attr("name","usuario[]").attr("id","usuario_"+this.id).val(this.id))).append($("<td/>").addClass("login").html(this.login).click(function(){Ponto._trocaUsuario(t)})).append($("<td/>").addClass("nome").html(this.nome).click(function(){Ponto._trocaUsuario(t)})).append($("<td/>").addClass("email").html(this.email)).append($("<td/>").addClass("expediente").html(this.horas_dia+" / "+this.horas_almoco))})):$("<div/>").addClass("noResult").html("Você não possui usuários cadastrados").appendTo($(".widget-usuarios")),$(".widget-usuarios").dialog({title:"Usuários",width:600,modal:!0,resizable:!1,buttons:{"Cadastrar Usuário":function(){Ponto._adicionarUsuario()},"Remover selecionados":function(){var a=$("#tbUsuarios input:checkbox:checked"),t=new Array;if(a.each(function(a){t[a]=$(this).val()}),0!==t.length){var o="Remover permanentemente o(s) usuário(s) selecionado(s)? <br/>Todos os dados relacionados a este usuário serão removidos de forma irreversível.";$("<div/>").attr("id","apagar-form").html(o).appendTo($("#Ponto")).dialog({title:"Remover usuários",width:400,modal:!0,resizable:!1,buttons:{Continuar:function(){$(this).dialog("close"),$("#apagar-form").remove(),$(".widget-usuarios").remove(),Ponto._removerUsuario(t),Ponto.init()},Fechar:function(){$(this).dialog("close"),$("#apagar-form").remove()}},close:function(){$("#apagar-form").remove()}})}else Ponto._showErro("Selecione algum usuário para remover.")},Fechar:function(){$(this).dialog("close"),$(".widget-usuarios").remove()}},close:function(){$(".widget-usuarios").remove()}})},dataType:"json"})}};
